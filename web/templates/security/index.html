{% extends "base.html" %}
{% block title %}Segurança - Landlord{% endblock %}
{% block content %}
<div class="page-header">
    <div class="page-header-info">
        <h2 class="page-title">Segurança</h2>
        <p class="page-subtitle">Gerencie sua senha e configurações de autenticação multifator.</p>
    </div>
</div>

<div class="panel">
    <div class="panel-head"><h5>Alterar Senha</h5></div>
    <div class="panel-body">
        {% if password_error %}
        <div class="toast toast--danger" role="alert">{{ password_error }}</div>
        {% endif %}
        <form method="post" action="/security/change-password">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="field">
                <label for="current_password" class="field-label">Senha atual</label>
                <input type="password" class="field-input" id="current_password"
                       name="current_password" required style="max-width: 350px;">
            </div>
            <div class="field">
                <label for="new_password" class="field-label">Nova senha</label>
                <input type="password" class="field-input" id="new_password"
                       name="new_password" required style="max-width: 350px;">
            </div>
            <div class="field">
                <label for="confirm_password" class="field-label">Confirmar nova senha</label>
                <input type="password" class="field-input" id="confirm_password"
                       name="confirm_password" required style="max-width: 350px;">
            </div>
            <button type="submit" class="btn btn--primary btn--sm">Alterar Senha</button>
        </form>
    </div>
</div>

<div class="panel">
    <div class="panel-head"><h5>Autenticação por Aplicativo (TOTP)</h5></div>
    <div class="panel-body">
        {% if has_totp %}
        <p>TOTP está <strong style="color: var(--emerald);">ativado</strong>.</p>
        <p style="margin-top: 0.5rem;">Códigos de recuperação restantes: <strong>{{ recovery_count }}</strong>
            {% if recovery_count < 3 %}
            <span style="color: var(--danger); font-weight: 600;"> — Recomendamos regenerar seus códigos.</span>
            {% endif %}
        </p>
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 1rem;">
            <form method="post" action="/security/recovery-codes/regenerate">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button type="submit" class="btn btn--sm">Regenerar Códigos de Recuperação</button>
            </form>
            <button class="btn btn--sm btn--danger" onclick="document.getElementById('disable-totp').style.display='block'; this.style.display='none';">Desativar TOTP</button>
        </div>
        <div id="disable-totp" style="display:none; margin-top: 1rem;" class="panel" style="box-shadow: none;">
            <div class="panel-body">
                <form method="post" action="/security/totp/disable">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="field">
                        <label class="field-label">Confirme sua senha para desativar</label>
                        <input type="password" class="field-input" name="password" required>
                    </div>
                    <button type="submit" class="btn btn--danger btn--sm">Confirmar Desativação</button>
                </form>
            </div>
        </div>
        {% else %}
        <p>TOTP não está configurado.</p>
        <a href="/security/totp/setup" class="btn btn--primary" style="margin-top: 0.75rem;">Configurar TOTP</a>
        {% endif %}
    </div>
</div>

<div class="panel">
    <div class="panel-head"><h5>Passkeys (Chaves de Acesso)</h5></div>
    <div class="panel-body">
        {% if passkeys %}
        <div class="data-table-wrap">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Criada em</th>
                        <th>Último uso</th>
                        <th class="text-right">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pk in passkeys %}
                    <tr>
                        <td>{{ pk.name or "Sem nome" }}</td>
                        <td>{{ pk.created_at.strftime('%d/%m/%Y') if pk.created_at else '-' }}</td>
                        <td>{{ pk.last_used_at.strftime('%d/%m/%Y') if pk.last_used_at else 'Nunca' }}</td>
                        <td class="text-right">
                            <form method="post" action="/security/passkeys/{{ pk.uuid }}/delete"
                                  onsubmit="return confirm('Remover esta passkey?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <button type="submit" class="btn btn--sm btn--danger">Remover</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>Nenhuma passkey cadastrada.</p>
        {% endif %}
        <div style="display: flex; gap: 0.75rem; align-items: center; margin-top: 1rem; flex-wrap: wrap;">
            <input type="text" id="passkey-name" class="field-input" placeholder="Nome da passkey" style="width: 220px;">
            <button id="register-passkey-btn" class="btn btn--primary btn--sm">Adicionar Passkey</button>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="{{ url_for('static', path='core/js/webauthn.js') }}?v={{ asset_version }}"></script>
<script>
document.getElementById('register-passkey-btn').addEventListener('click', function() {
    var name = document.getElementById('passkey-name').value.trim() || 'Minha Passkey';
    webauthnRegister('/security/passkeys/register/begin', '/security/passkeys/register/complete', name);
});
</script>
{% endblock %}
