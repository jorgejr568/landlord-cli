{% extends "base.html" %}

{% block title %}Fatura {{ format_month(bill.reference_month) }} - Rentivo{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-info">
        <h2 class="page-title">
            Fatura — {{ format_month(bill.reference_month) }}
            {% if bill.status == "draft" %}
            <span class="tag tag--draft">Rascunho</span>
            {% elif bill.status == "published" %}
            <span class="tag tag--published">Publicado</span>
            {% elif bill.status == "sent" %}
            <span class="tag tag--sent">Enviado</span>
            {% elif bill.status == "paid" %}
            <span class="tag tag--paid">Pago</span>
            {% elif bill.status == "cancelled" %}
            <span class="tag tag--cancelled">Cancelado</span>
            {% elif bill.status == "delayed_payment" %}
            <span class="tag tag--delayed">Pag. Atrasado</span>
            {% endif %}
        </h2>
        <p class="page-subtitle">Cobrança: {{ billing.name }}</p>
    </div>
    <div class="page-actions">
        {% if bill.pdf_path %}
        <a href="/billings/{{ billing.uuid }}/bills/{{ bill.uuid }}/invoice" target="_blank" class="btn btn--primary">Ver PDF</a>
        {% endif %}
        {% if role in ("owner", "admin", "manager") %}
        <form method="post" action="/billings/{{ billing.uuid }}/bills/{{ bill.uuid }}/regenerate-pdf" class="inline-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn">Regenerar PDF</button>
        </form>
        <form method="post" action="/billings/{{ billing.uuid }}/bills/{{ bill.uuid }}/change-status" class="inline-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <select name="status" class="field-select" style="width:auto;display:inline-block;" onchange="this.form.submit()">
                <option value="draft" {% if bill.status == "draft" %}selected{% endif %}>Rascunho</option>
                <option value="published" {% if bill.status == "published" %}selected{% endif %}>Publicado</option>
                <option value="sent" {% if bill.status == "sent" %}selected{% endif %}>Enviado</option>
                <option value="paid" {% if bill.status == "paid" %}selected{% endif %}>Pago</option>
                <option value="cancelled" {% if bill.status == "cancelled" %}selected{% endif %}>Cancelado</option>
                <option value="delayed_payment" {% if bill.status == "delayed_payment" %}selected{% endif %}>Pag. Atrasado</option>
            </select>
        </form>
        <a href="/billings/{{ billing.uuid }}/bills/{{ bill.uuid }}/edit" class="btn">Editar</a>
        {% endif %}
    </div>
</div>

<div class="panel">
    <div class="data-table-wrap">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Descrição</th>
                    <th class="text-center">Tipo</th>
                    <th class="text-right">Valor</th>
                </tr>
            </thead>
            <tbody>
                {% for item in bill.line_items %}
                <tr>
                    <td>{{ item.description }}</td>
                    <td class="text-center">
                        {% if item.item_type.value == "fixed" %}
                        <span class="tag tag--fixed">Fixo</span>
                        {% elif item.item_type.value == "variable" %}
                        <span class="tag tag--variable">Variável</span>
                        {% else %}
                        <span class="tag tag--extra">Extra</span>
                        {% endif %}
                    </td>
                    <td class="text-right text-mono">{{ format_brl(item.amount) }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="2" class="text-right">Total</td>
                    <td class="text-right text-mono">{{ format_brl(bill.total_amount) }}</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

{% if bill.due_date or bill.status_updated_at %}
<div class="detail-meta">
    {% if bill.due_date %}
    <div class="detail-meta-item">
        <strong>Vencimento:</strong> {{ bill.due_date }}
    </div>
    {% endif %}
    {% if bill.status_updated_at %}
    <div class="detail-meta-item">
        <strong>Status atualizado em:</strong> {{ bill.status_updated_at.strftime("%d/%m/%Y %H:%M") }}
    </div>
    {% endif %}
</div>
{% endif %}

{% if bill.notes %}
<div class="panel">
    <div class="panel-head"><h6>Observações</h6></div>
    <div class="panel-body">{{ bill.notes }}</div>
</div>
{% endif %}

<div class="panel">
    <div class="panel-head"><h6>Comprovantes</h6></div>
    <div class="panel-body">
        {% if receipts %}
        <table class="data-table" style="margin-bottom: 1rem;">
            <thead>
                <tr>
                    {% if role in ("owner", "admin", "manager") %}
                    <th style="width:2rem;"></th>
                    {% endif %}
                    <th>Arquivo</th>
                    <th class="text-right">Tamanho</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="receipt-list"
                   data-reorder-url="/billings/{{ billing.uuid }}/bills/{{ bill.uuid }}/receipts/reorder"
                   data-csrf="{{ csrf_token }}">
                {% for receipt in receipts %}
                <tr data-uuid="{{ receipt.uuid }}">
                    {% if role in ("owner", "admin", "manager") %}
                    <td class="drag-handle">&equiv;</td>
                    {% endif %}
                    <td>{{ receipt.filename }}</td>
                    <td class="text-right">{{ "%.1f" | format(receipt.file_size / 1024) }} KB</td>
                    <td class="text-right" style="white-space: nowrap;">
                        <a href="/billings/{{ billing.uuid }}/bills/{{ bill.uuid }}/receipts/{{ receipt.uuid }}"
                           target="_blank" class="btn btn--sm">Ver</a>
                        {% if role in ("owner", "admin", "manager") %}
                        <form method="post"
                              action="/billings/{{ billing.uuid }}/bills/{{ bill.uuid }}/receipts/{{ receipt.uuid }}/delete"
                              style="display:inline"
                              onsubmit="return confirm('Remover comprovante?')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <input type="hidden" name="next" value="/billings/{{ billing.uuid }}/bills/{{ bill.uuid }}">
                            <button type="submit" class="btn btn--sm btn--danger">Remover</button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted">Nenhum comprovante anexado.</p>
        {% endif %}

        {% if role in ("owner", "admin", "manager") %}
        <form method="post"
              action="/billings/{{ billing.uuid }}/bills/{{ bill.uuid }}/receipts/upload"
              enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="hidden" name="next" value="/billings/{{ billing.uuid }}/bills/{{ bill.uuid }}">
            <div class="field">
                <label for="receipt_files" class="field-label">Anexar comprovantes</label>
                <input type="file" class="field-input" id="receipt_files" name="receipt_files"
                       accept=".pdf,.jpg,.jpeg,.png" multiple>
                <small class="text-muted">PDF, JPG ou PNG. Máximo 10 MB cada. Você pode selecionar vários arquivos.</small>
            </div>
            <button type="submit" class="btn btn--sm btn--primary">Enviar</button>
        </form>
        {% endif %}
    </div>
</div>

<div class="btn-group">
    <a href="/billings/{{ billing.uuid }}" class="btn btn--ghost">Voltar</a>
    {% if role in ("owner", "admin", "manager") %}
    <form method="post" action="/billings/{{ billing.uuid }}/bills/{{ bill.uuid }}/delete"
          onsubmit="return confirm('Tem certeza que deseja excluir esta fatura?')">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button type="submit" class="btn btn--danger">Excluir Fatura</button>
    </form>
    {% endif %}
</div>
{% endblock %}

{% if receipts and role in ("owner", "admin", "manager") %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.7/Sortable.min.js"></script>
<script>
(function () {
    var el = document.getElementById('receipt-list');
    if (!el) return;
    Sortable.create(el, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: function () {
            var rows = el.querySelectorAll('tr[data-uuid]');
            var order = [];
            for (var i = 0; i < rows.length; i++) {
                order.push(rows[i].getAttribute('data-uuid'));
            }
            fetch(el.getAttribute('data-reorder-url'), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': el.getAttribute('data-csrf')
                },
                body: JSON.stringify({ order: order })
            });
        }
    });
})();
</script>
{% endblock %}
{% endif %}
